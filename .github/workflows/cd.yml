name: CD Deploy to Server

on:
  workflow_dispatch:   # ìˆ˜ë™ ë°°í¬ìš©
  workflow_run:        # docker-publish ì„±ê³µ ë’¤ ìë™ ë°°í¬
    workflows: [ "CI Build and Push Docker" ]
    types: [ completed ]
    branches: [ "main" ]

jobs:
  deploy:
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success')
    runs-on: self-hosted          # â† ë¡œì»¬ PC ëŸ¬ë„ˆë¼ë©´ ê·¸ëŒ€ë¡œ

    steps:
      - name: Checkout (logs only)
        uses: actions/checkout@v4

      # --- â‘  GHCR ë¡œê·¸ì¸ ---
      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io \
               -u ${{ secrets.GHCR_USERNAME }} --password-stdin

      # --- â‘¡ ì´ë¯¸ì§€ Pull & ì¬ê¸°ë™ ---
      - name: Pull latest image and restart
        run: |
          TAG=${{ github.event.inputs.image_tag || 'latest' }}
          IMAGE=ghcr.io/${{ secrets.GHCR_USERNAME }}/spring-thyme-app:$TAG

          echo "Pull $IMAGE"
          docker pull $IMAGE

          echo "Stop / Remove old container (if any)"
          docker stop spring-app || true
          docker rm   spring-app || true

          echo "Run new container"
          docker run -d --name spring-app -p 8080:8080 \
            -e SPRING_PROFILES_ACTIVE=prod \
            $IMAGE
            
    # runs-on: ubuntu-latest

    # steps:
    #   # â‘¡ (ì„ íƒ) ì‹¤í–‰ ì¤‘ì¸ ë‹¤ë¥¸ ì›Œí¬í”Œë¡œ ë¡œê·¸ í™•ì¸ìš©
    #   - name: Checkout (for logs only)
    #     uses: actions/checkout@v4

    #   # â‘¢ SSH ì ‘ì†í•´ ì»¨í…Œì´ë„ˆ êµì²´
    #   - name: SSH into server and deploy
    #     uses: appleboy/ssh-action@v1.0.3
    #     with:
    #       host:     ${{ secrets.SSH_HOST }}     # ì˜ˆ: 13.124.xxx.xxx
    #       username: ${{ secrets.SSH_USER }}     # ì˜ˆ: ec2-user
    #       key:      ${{ secrets.SSH_KEY }}      # ê°œì¸í‚¤(PKCS8) ë‚´ìš©
    #       script: |
    #         set -e

    #         echo "ğŸ” Docker Hub ë¡œê·¸ì¸"
    #         docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

    #         echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ Pull"
    #         docker pull ${{ secrets.DOCKERHUB_USERNAME }}/spring-thyme-app:latest

    #         echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ(ì—†ì–´ë„ ë¬´ì‹œ)"
    #         docker stop spring-app || true
    #         docker rm   spring-app || true

    #         echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ê¸°ë™"
    #         docker run -d --name spring-app \
    #           -p 8080:8080 \
    #           -e SPRING_PROFILES_ACTIVE=prod \
    #           -e FILE_DIR=/data/files \
    #           -v /opt/spring/files:/data/files \
    #           ${{ secrets.DOCKERHUB_USERNAME }}/spring-thyme-app:latest
