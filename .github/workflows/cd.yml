# .github/workflows/cd.yml
name: CD Deploy to Server

# â‘  docker-publish ì›Œí¬í”Œë¡œê°€ main ë¸Œëœì¹˜ì—ì„œ ì„±ê³µì ìœ¼ë¡œ ëë‚¬ì„ ë•Œë§Œ íŠ¸ë¦¬ê±°
on:
  workflow_run:
    workflows: ["docker-publish"]   # â† docker ì´ë¯¸ì§€ë¥¼ í‘¸ì‹œí•˜ëŠ” ê¸°ì¡´ workflow ì´ë¦„
    types: [ completed ]
    branches: [ "main" ]

jobs:
  deploy:
    # docker-publish ì„±ê³µì¼ ë•Œë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # â‘¡ (ì„ íƒ) ì‹¤í–‰ ì¤‘ì¸ ë‹¤ë¥¸ ì›Œí¬í”Œë¡œ ë¡œê·¸ í™•ì¸ìš©
      - name: Checkout (for logs only)
        uses: actions/checkout@v4

      # â‘¢ SSH ì ‘ì†í•´ ì»¨í…Œì´ë„ˆ êµì²´
      - name: SSH into server and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SSH_HOST }}     # ì˜ˆ: 13.124.xxx.xxx
          username: ${{ secrets.SSH_USER }}     # ì˜ˆ: ec2-user
          key:      ${{ secrets.SSH_KEY }}      # ê°œì¸í‚¤(PKCS8) ë‚´ìš©
          script: |
            set -e

            echo "ğŸ” Docker Hub ë¡œê·¸ì¸"
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

            echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ Pull"
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/spring-thyme-app:latest

            echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ(ì—†ì–´ë„ ë¬´ì‹œ)"
            docker stop spring-app || true
            docker rm   spring-app || true

            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ê¸°ë™"
            docker run -d --name spring-app \
              -p 8080:8080 \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e FILE_DIR=/data/files \
              -v /opt/spring/files:/data/files \
              ${{ secrets.DOCKERHUB_USERNAME }}/spring-thyme-app:latest
